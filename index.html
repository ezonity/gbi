<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Schedule Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .form-section {
            border: 1px solid #e2e8f0; /* slate-200 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
        }
        .form-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b; /* slate-800 */
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-6">

    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full border border-slate-200">
        <div class="relative text-center mb-8">
            <div class="absolute left-0 top-0 flex items-center gap-3 h-full">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjRkRCMDEzIi8+PHRleHQgeD0iNTAiIHk9IjY1IiBmb250LWZhbWlseT0iY3Vyc2l2ZSwgc2VyaWYiIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJib2xkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSI+RzwvdGV4dD48L3N2Zz4=" alt="GBI Logo" class="h-10 w-10 object-contain">
                <span class="text-2xl font-bold text-slate-700">GBI</span>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 inline-block">Employee Schedule Manager</h2>
        </div>
        
        <!-- CSV Upload Section -->
        <div class="form-section bg-slate-50/50">
            <h3 class="form-section-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                <span>Bulk Upload (CSV)</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                <div class="md:col-span-2">
                    <label for="csv-file-input" class="sr-only">Select CSV File</label>
                    <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 transition-colors">
                </div>
                <div class="self-end">
                    <button type="button" id="upload-csv-btn" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                        Process CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Form for entering schedule data -->
        <form id="schedule-form" class="space-y-6">
            <!-- Employee Information Section -->
            <div class="form-section">
                <h3 class="form-section-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span>Manual Entry</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="owfId" class="block text-sm font-medium text-slate-700">OWF ID</label>
                        <input type="text" id="owfId" name="owfId" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., 12345" required>
                    </div>
                    <div>
                        <label for="employeeName" class="block text-sm font-medium text-slate-700">Employee Name</label>
                        <input type="text" id="employeeName" name="employeeName" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., Bloy, Carlito" required>
                    </div>
                    <div>
                        <label for="agencyName" class="block text-sm font-medium text-slate-700">Agency Name</label>
                        <select id="agencyName" name="agencyName" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                            <option value="">Select an Agency</option>
                            <option value="Staff Alliance">Staff Alliance</option>
                            <option value="BMirk">BMirk</option>
                            <option value="Expedise">Expedise</option>
                            <option value="Green Pasture">Green Pasture</option>
                        </select>
                    </div>
                    <div>
                        <label for="zone" class="block text-sm font-medium text-slate-700">Zone</label>
                        <input type="text" id="zone" name="zone" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., FEMS" required>
                    </div>
                    <div>
                        <label for="site" class="block text-sm font-medium text-slate-700">Site</label>
                        <select id="site" name="site" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                            <option value="">Select a Site</option>
                            <option value="CP">CP</option>
                            <option value="BP">BP</option>
                            <option value="CFC">CFC</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Dynamic Schedule Blocks Section -->
            <div id="schedule-blocks-container" class="form-section">
                <div class="schedule-block border-none p-0 m-0">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-slate-700">Schedule 1</h3>
                        <button type="button" class="remove-schedule-btn hidden text-sm font-medium text-red-600 hover:text-red-800">&times; Remove</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="transactionDateFrom_1" class="block text-sm font-medium text-slate-700">Date From</label>
                            <input type="date" name="transactionDateFrom" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                        </div>
                        <div>
                            <label for="transactionDateTo_1" class="block text-sm font-medium text-slate-700">Date To</label>
                            <input type="date" name="transactionDateTo" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="workSchedule_1" class="block text-sm font-medium text-slate-700">Work Schedule</label>
                            <input type="text" name="workSchedule" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., 8am-5pm" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="restDay_1" class="block text-sm font-medium text-slate-700">Rest Day</label>
                            <select name="restDay" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                                <option value="">Select a Day</option>
                                <option value="Sunday">Sunday</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="button" id="add-schedule-btn" class="w-full flex justify-center items-center gap-2 py-2 px-4 border-2 border-dashed border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:border-sky-500 hover:text-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Another Schedule Block
            </button>
            
            <!-- Specific Schedule Changes Section -->
            <div class="form-section">
                 <h3 class="form-section-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect width="18" height="18" x="3" y="4" rx="2"></rect><path d="M3 10h18"></path><path d="m9 16 2 2 4-4"></path></svg>
                    <span>Special Schedule Changes (Optional)</span>
                </h3>
                <div id="specific-changes-container" class="space-y-4">
                    <!-- Template for a single change -->
                    <div id="specific-change-template" class="specific-change-block grid grid-cols-1 md:grid-cols-3 gap-4 items-center hidden">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Day of Week</label>
                            <select name="specificDay" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                                <option value="">Select a Day</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">New Work Schedule</label>
                            <input type="text" name="specificSchedule" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., 7am-4pm or RESTDAY">
                        </div>
                        <div class="self-end pt-5">
                             <button type="button" class="remove-specific-btn w-full flex items-center justify-center gap-2 py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-red-600 hover:text-red-800 hover:bg-red-50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
                <button type="button" id="add-specific-change-btn" class="mt-4 w-full flex justify-center items-center gap-2 py-2 px-4 border-2 border-dashed border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:border-sky-500 hover:text-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Specific Change
                </button>
            </div>

            <div class="pt-4">
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                    Submit All Schedules
                </button>
            </div>
        </form>

        <!-- Status message for feedback -->
        <div id="status-message" class="mt-6 text-center hidden p-3 rounded-lg"></div>

        <!-- Container for the output table and buttons -->
        <div id="output-container" class="mt-8 border-t-2 border-slate-200 pt-8 hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <h3 class="text-xl font-bold text-slate-800">Generated Schedules</h3>
                <div class="flex space-x-2">
                    <button id="export-button" class="flex items-center gap-2 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Export
                    </button>
                    <button id="clear-button" class="flex items-center gap-2 py-2 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        Clear
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto rounded-lg border border-slate-200">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">OWF ID</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Agency</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Schedule</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Hours</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Zone</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Site</th>
                        </tr>
                    </thead>
                    <tbody id="output-table-body" class="bg-white divide-y divide-slate-200">
                        <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="flex justify-between items-center text-xs text-gray-400 mt-6">
            <div>© 2025 Powered by: EZONE</div>
            <div>Version: Angel Cake</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get all elements
            const scheduleForm = document.getElementById('schedule-form');
            const statusMessage = document.getElementById('status-message');
            const outputContainer = document.getElementById('output-container');
            const outputTableBody = document.getElementById('output-table-body');
            const clearButton = document.getElementById('clear-button');
            const exportButton = document.getElementById('export-button');
            const addScheduleBtn = document.getElementById('add-schedule-btn');
            const scheduleBlocksContainer = document.getElementById('schedule-blocks-container');
            const csvFileInput = document.getElementById('csv-file-input');
            const uploadCsvBtn = document.getElementById('upload-csv-btn');
            const addSpecificChangeBtn = document.getElementById('add-specific-change-btn');
            const specificChangesContainer = document.getElementById('specific-changes-container');
            const specificChangeTemplate = document.getElementById('specific-change-template');
            let scheduleBlockCount = 1;

            // --- CSV Upload Logic ---
            uploadCsvBtn.addEventListener('click', () => {
                const file = csvFileInput.files[0];
                if (!file) {
                    showStatusMessage('Please select a CSV file first.', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const csvText = event.target.result;
                    processCSV(csvText);
                };
                reader.readAsText(file);
            });
            
            function parseCsvLine(line) {
                const columns = [];
                const regex = /(?:"([^"]*(?:""[^"]*)*)"|([^,]*))(,|$)/g;
                let match;
                while ((match = regex.exec(line))) {
                    let column = match[1] !== undefined ? match[1].replace(/""/g, '"') : match[2];
                    columns.push(column.trim());
                    if (match[3] === '') break;
                }
                return columns;
            }

            function processCSV(csvText) {
                const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
                if (lines.length <= 1) {
                    showStatusMessage('No data found in the CSV file.', 'error');
                    return;
                }

                const dataRows = lines.slice(1);
                let mainSchedules = [];
                const overrides = {}; // Key: owfId-date, Value: schedule
                let skippedCount = 0;
                let overridesFound = 0;

                dataRows.forEach(line => {
                    const columns = parseCsvLine(line);
                    if (columns.length < 10) {
                        skippedCount++;
                        console.warn('Skipping malformed row:', line);
                        return;
                    }
                    const recordType = columns[0].toLowerCase();
                    const owfId = columns[1];

                    if (recordType === 'main') {
                        mainSchedules.push({
                            employeeInfo: { owfId, employeeName: columns[2], agencyName: columns[3], zone: columns[4], site: columns[5] },
                            scheduleData: { transactionDateFrom: columns[6], transactionDateTo: columns[7], workSchedule: columns[8], restDay: columns[9] }
                        });
                    } else if (recordType === 'override') {
                        overridesFound++;
                        const overrideDate = columns[6];
                        const overrideSchedule = columns[8];
                        if (!owfId || !overrideDate) {
                            skippedCount++;
                            console.warn('Skipping override row with missing OWF ID or Date:', line);
                            return;
                        }
                        const key = `${owfId}-${overrideDate}`;
                        overrides[key] = overrideSchedule;
                    }
                });
                
                const appliedOverrides = new Set();
                mainSchedules.forEach(item => {
                    addScheduleToTable(item.employeeInfo, item.scheduleData, overrides, appliedOverrides);
                });
                
                let message = '';
                let messageType = 'success';

                if (mainSchedules.length > 0) {
                    message = `${mainSchedules.length} main schedule(s) processed successfully. `;
                    outputContainer.style.display = 'block';
                } else {
                     message = 'No "Main" records found in CSV. ';
                     messageType = 'error';
                }

                if (overridesFound > 0) {
                    message += `${appliedOverrides.size} of ${overridesFound} override(s) applied successfully. `;
                    if (appliedOverrides.size < overridesFound) {
                        messageType = 'info';
                         message += `Please check if the OWF ID and Date for the ${overridesFound - appliedOverrides.size} unused override(s) match a "Main" schedule.`;
                    }
                }

                if (skippedCount > 0) {
                    message += `${skippedCount} row(s) were skipped due to incorrect formatting. `;
                    messageType = 'error';
                }
                
                showStatusMessage(message, messageType);
                csvFileInput.value = '';
            }


            // --- Manual Form Logic ---
            const addScheduleBlock = () => {
                scheduleBlockCount++;
                const newBlock = document.createElement('div');
                newBlock.className = 'schedule-block';
                newBlock.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-slate-700">Schedule ${scheduleBlockCount}</h3><button type="button" class="remove-schedule-btn text-sm font-medium text-red-600 hover:text-red-800">&times; Remove</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium text-slate-700">Date From</label><input type="date" name="transactionDateFrom" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required></div><div><label class="block text-sm font-medium text-slate-700">Date To</label><input type="date" name="transactionDateTo" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required></div><div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700">Work Schedule</label><input type="text" name="workSchedule" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., 9am-6pm" required></div><div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700">Rest Day</label><select name="restDay" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"><option value="">Select a Day</option><option value="Sunday">Sunday</option><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option><option value="Saturday">Saturday</option></select></div></div>`;
                scheduleBlocksContainer.appendChild(newBlock);
            };
            
            addScheduleBtn.addEventListener('click', addScheduleBlock);

            scheduleBlocksContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-schedule-btn')) {
                    e.target.closest('.schedule-block').remove();
                }
            });

            // --- Specific Changes Logic ---
            addSpecificChangeBtn.addEventListener('click', () => {
                const newChangeBlock = specificChangeTemplate.cloneNode(true);
                newChangeBlock.id = '';
                newChangeBlock.classList.remove('hidden');
                specificChangesContainer.appendChild(newChangeBlock);
            });

            specificChangesContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-specific-btn')) {
                    e.target.closest('.specific-change-block').remove();
                }
            });

            scheduleForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const employeeInfo = {
                    owfId: document.getElementById('owfId').value,
                    employeeName: document.getElementById('employeeName').value,
                    agencyName: document.getElementById('agencyName').value,
                    zone: document.getElementById('zone').value,
                    site: document.getElementById('site').value
                };
                
                if (!employeeInfo.owfId || !employeeInfo.employeeName || !employeeInfo.agencyName || !employeeInfo.zone || !employeeInfo.site) {
                    showStatusMessage('Please fill out all employee information fields.', 'error');
                    return;
                }

                // Gather specific overrides from manual form
                const dayOverrides = {};
                document.querySelectorAll('.specific-change-block:not(#specific-change-template)').forEach(block => {
                    const day = block.querySelector('[name="specificDay"]').value;
                    const schedule = block.querySelector('[name="specificSchedule"]').value;
                    if (day && schedule) {
                        dayOverrides[day.toLowerCase()] = schedule;
                    }
                });
                
                outputContainer.style.display = 'block';
                let allSchedulesValid = true;
                const scheduleBlocks = scheduleBlocksContainer.querySelectorAll('.schedule-block');
                
                scheduleBlocks.forEach(block => {
                    const scheduleData = {
                        transactionDateFrom: block.querySelector('[name="transactionDateFrom"]').value,
                        transactionDateTo: block.querySelector('[name="transactionDateTo"]').value,
                        workSchedule: block.querySelector('[name="workSchedule"]').value,
                        restDay: block.querySelector('[name="restDay"]').value,
                    };

                    if (!scheduleData.transactionDateFrom || !scheduleData.transactionDateTo || !scheduleData.workSchedule) {
                        allSchedulesValid = false;
                        return;
                    }
                    addScheduleToTable(employeeInfo, scheduleData, dayOverrides, new Set());
                });

                if (!allSchedulesValid) {
                     showStatusMessage('Please fill out all fields in every schedule block.', 'error');
                     return;
                }

                showStatusMessage('Schedules processed successfully!', 'success');
            });

            // --- Shared Functions ---
            function addScheduleToTable(employeeInfo, scheduleData, overrides, appliedOverrides) {
                const startDate = new Date(scheduleData.transactionDateFrom);
                const endDate = new Date(scheduleData.transactionDateTo);
                
                if (isNaN(startDate) || isNaN(endDate)) {
                    console.error("Invalid date range for", employeeInfo.owfId);
                    return;
                }
                
                startDate.setMinutes(startDate.getMinutes() + startDate.getTimezoneOffset());
                endDate.setMinutes(endDate.getMinutes() + endDate.getTimezoneOffset());
                
                const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const currentDateString = d.toLocaleDateString('en-CA'); // Format: YYYY-MM-DD
                    const dayOfWeek = dayNames[d.getDay()].toLowerCase();
                    
                    let scheduleToDisplay = '';
                    
                    const csvOverrideKey = `${employeeInfo.owfId}-${currentDateString}`;
                    if (overrides.hasOwnProperty(csvOverrideKey)) {
                        scheduleToDisplay = overrides[csvOverrideKey].toUpperCase() === 'RESTDAY' ? 'RESTDAY' : convertToMilitaryTime(overrides[csvOverrideKey]);
                        appliedOverrides.add(csvOverrideKey); // Track that this override was used
                    } else if (overrides.hasOwnProperty(dayOfWeek)) {
                        scheduleToDisplay = overrides[dayOfWeek].toUpperCase() === 'RESTDAY' ? 'RESTDAY' : convertToMilitaryTime(overrides[dayOfWeek]);
                    } else {
                        if (scheduleData.restDay && dayOfWeek === scheduleData.restDay.toLowerCase()) {
                            scheduleToDisplay = 'RESTDAY';
                        } else {
                            scheduleToDisplay = convertToMilitaryTime(scheduleData.workSchedule);
                        }
                    }

                    const totalHours = calculateWorkHours(scheduleToDisplay);
                    
                    const newRow = outputTableBody.insertRow();
                    newRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${employeeInfo.owfId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${employeeInfo.employeeName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${employeeInfo.agencyName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${currentDateString}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${scheduleToDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-slate-500">${totalHours.toFixed(1)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${employeeInfo.zone}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${employeeInfo.site}</td>
                    `;
                }
            }

            clearButton.addEventListener('click', function() {
                outputTableBody.innerHTML = '';
                outputContainer.style.display = 'none';
                showStatusMessage('Table cleared.', 'info');
                document.querySelectorAll('.specific-change-block:not(#specific-change-template)').forEach(block => block.remove());
            });

            exportButton.addEventListener('click', function() {
                const table = document.querySelector('table');
                if (table.rows.length <= 1) {
                    showStatusMessage('Nothing to export.', 'error');
                    return;
                }
                let csv = [];
                let headers = [];
                table.querySelectorAll('th').forEach(header => headers.push(`"${header.textContent}"`));
                csv.push(headers.join(','));
                table.querySelectorAll('tbody tr').forEach(row => {
                    let rowData = [];
                    row.querySelectorAll('td').forEach(cell => {
                        let text = cell.textContent.replace(/"/g, '""');
                        rowData.push(`"${text}"`);
                    });
                    csv.push(rowData.join(','));
                });
                downloadCSV(csv.join('\n'), 'employee_schedule_export.csv');
            });

            function showStatusMessage(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
                const typeClasses = {
                    success: 'bg-teal-100 text-teal-800',
                    error: 'bg-red-100 text-red-800',
                    info: 'bg-sky-100 text-sky-800'
                };
                statusMessage.className = `mt-6 text-center p-3 rounded-lg font-medium ${typeClasses[type] || typeClasses['info']}`;
                setTimeout(() => { statusMessage.style.display = 'none'; }, 7000); // Increased timeout for longer messages
            }

            function downloadCSV(csv, filename) {
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function convertToMilitaryTime(timeString) {
                if (!timeString || typeof timeString !== 'string' || timeString.toUpperCase() === 'RESTDAY') return 'RESTDAY';
                
                const parts = timeString.replace(/–|—/g, '-').split('-').map(part => part.trim());

                if (parts.length !== 2) {
                    return timeString; 
                }

                const convertSingleTime = (part) => {
                    let time = part.toLowerCase().replace(/\s/g, '');
                    let hours;
                    let minutes = 0;

                    const ampmMatch = time.match(/^(\d{1,2})(?::(\d{2}))?(am|pm)$/);
                    
                    if (ampmMatch) {
                        hours = parseInt(ampmMatch[1], 10);
                        minutes = ampmMatch[2] ? parseInt(ampmMatch[2], 10) : 0;
                        const period = ampmMatch[3];

                        if (period === 'am') {
                            if (hours === 12) hours = 0;
                        } else if (period === 'pm') {
                            if (hours !== 12) hours += 12;
                        }
                    } else {
                        const militaryMatch = time.match(/^(\d{2,4})$/);
                        if (militaryMatch) {
                            const t = militaryMatch[1].padStart(4, '0');
                            hours = parseInt(t.substring(0, 2), 10);
                            minutes = parseInt(t.substring(2, 4), 10);
                        } else {
                            return part;
                        }
                    }

                    if (isNaN(hours) || isNaN(minutes) || hours > 23 || minutes > 59) {
                        return part;
                    }
                    
                    return hours.toString().padStart(2, '0') + minutes.toString().padStart(2, '0');
                };

                return parts.map(convertSingleTime).join('-');
            }

            function calculateWorkHours(militarySchedule) {
                if (!militarySchedule || militarySchedule === 'RESTDAY') return 0;
                const parts = militarySchedule.split('-');
                if (parts.length !== 2) return 0;
                const [startTime, endTime] = parts;
                const startHour = parseInt(startTime.substring(0, 2), 10);
                const startMinute = parseInt(startTime.substring(2, 4), 10);
                const endHour = parseInt(endTime.substring(0, 2), 10);
                const endMinute = parseInt(endTime.substring(2, 4), 10);
                if ([startHour, startMinute, endHour, endMinute].some(isNaN)) return 0;
                let startTotalMinutes = startHour * 60 + startMinute;
                let endTotalMinutes = endHour * 60 + endMinute;
                if (endTotalMinutes < startTotalMinutes) endTotalMinutes += 24 * 60;
                return (endTotalMinutes - startTotalMinutes) / 60;
            }
        });
    </script>
</body>
</html>
